# 2025 - 11 - 14 

use my_db;

select * from train;

-- fetch top 7 days of order date records for each category ?
-- fetch top 7 highest sales by order date for each category ?

select category, new_order_date , `Order Date`, 
row_number() over(partition by category order by new_order_date desc) as r_n,
rank() over(partition by category order by new_order_date desc) as rn,
dense_rank() over(partition by category order by new_order_date desc) as d_rank
from train;

select category, new_order_date , `Order Date`, sales,
row_number() over(partition by category order by sales desc,new_order_date asc) as r_n,
rank() over(partition by category order by sales desc,new_order_date asc) as rn,
dense_rank() over(partition by category order by sales desc,new_order_date asc) as d_rank
from train;


-- Aggregation function ( min,max,avg , sum , count ) 

select * from train;
-- max , min ,avg, count,sum

-- Fetch Top 7 days of order date total sales amount for each category  ? 
select sales,category , new_order_date , new_ship_date, 
sum(sales) over(partition by category order by new_order_date desc,sales asc ) as total_amount ,
dense_rank() over(partition by category order by new_order_date desc ,sales asc)as rn
from train; 

-- select (731.94 + 81.424)/2 

-- Fetch Top 7 days total sales for each Categories
-- Running Total ( Cumulative Sum or Avg ) 

-- select `Ship Date`,`Ship Mode`,Segment,Region, Category, `Sub-Category`, Sales, new_order_date,
-- sum(Sales) over(partition by Category order by new_order_date desc) as total_sales,
-- avg(Sales) over(partition by Category order by new_order_date desc) as average_sales,
-- row_number()over(partition by Category order by new_order_date desc) as row_num,
-- dense_rank()over(partition by Category order by new_order_date desc) as d_rank
-- from train;

select * from  ( 
select `Ship Date`,`Ship Mode`,Segment,Region, Category, `Sub-Category`, Sales, 
sum(Sales) over(partition by Category order by Sales) as total_sales,
avg(Sales) over(partition by Category order by Sales) as average_sales,
row_number()over(partition by Category order by Sales) as row_num,
dense_rank()over(partition by Category order by Sales) as d_rank
from train ) as t
where row_num<= 7 ;



select `Ship Date`,`Ship Mode`,Segment,Region, Category, `Sub-Category`, Sales, 
sum(Sales) over(partition by Category order by Sales) as total_sales,
avg(Sales) over(partition by Category order by Sales) as avg_sales,
count(*)over(partition by Category order by Sales) as total_count,
max(Sales) over(partition by Category order by Sales) as max_sales,
min(Sales) over(partition by Category order by Sales) as min_sales,
row_number()over(partition by Category order by Sales ) as row_num
from train ;


select Category, `Sub-Category`,`Ship Mode`,Segment , Region,sales, 
ntile(3) over(order by sales ) as n_tile 
from train;

select Category, `Sub-Category`,`Ship Mode`,Segment , Region,sales, 
ntile(3) over(partition by `Ship Mode` order by sales ) as n_tile 
from train;




-- lag( first record will be zero )  and lead ( last recod will be zero 

select category, new_order_date , `Order Date`, sales ,

lag(new_order_date,1) over(order by new_order_date) as pre_date ,
lag(new_order_date,3) over(order by new_order_date) as pre_third,
lead(new_order_date,1) over(order by new_order_date) as next_date ,
lead(new_order_date,2) over(order by new_order_date) as next_second
from train;

select Category, `Sub-Category`,`Ship Mode`,Segment , Region,sales, 
lag(sales,3) over(partition by `Ship Mode` order by sales ) as prev_three,
lead(sales,3) over(partition by `Ship Mode` order by sales ) as next_three
from train;


select * from ( 
select Category, `Sub-Category`,`Ship Mode`,Segment , Region,sales, 
lag(sales,1) over(partition by `Ship Mode` order by sales ) as prev_three,
lead(sales,1) over(partition by `Ship Mode` order by sales ) as next_three
from train ) as t
where sales = prev_three;


select * from ( 
select `Order Date`, `Ship Date`,Category , `Sub-Category` , Sales,
lead(`Order Date`,1) over( partition by Category order by `Order Date` ) as next
from train ) as t 
where `Order Date` =next;

-- Find the first sales in each categories or ( Category , `Sub-Category` ) 
select * from ( 
select Category, `Sub-Category`,`Ship Mode`,Segment , Region,sales, 
row_number() over(partition by Category order by sales desc ) as first_val 
from train ) as t 
where first_val = 1;

-- first_value and last_value 
-- select * from ( 
select Category, `Sub-Category`,`Ship Mode`,Segment , Region,sales, 
first_value(sales) over(partition by Category order by sales) as first_val ,
row_number() over(partition by Category order by sales) as r_num ,
rank() over(partition by Category order by sales) as r ,
dense_rank() over(partition by Category order by sales) as d_rank
from train ;
-- ) as t 
-- where first_val = 1;


-- Running Total or Average 

select Category, `Sub-Category`,`Ship Mode`,Segment , Region,sales,
sum(sales) over(order by sales ) as total_sum,
avg(sales) over(order by sales ) as total_average
from train;

select Category, `Sub-Category`,`Ship Mode`,Segment , Region,sales,
sum(sales) over(partition by Category order by sales ) as total_sum,
avg(sales) over(partition by Category order by sales ) as total_average
from train;

-- Moving Average or sum ( 
select Category, `Sub-Category`,`Ship Mode`,Segment , Region,sales,
sum(sales) over(order by sales rows between 3 preceding and current row ) as total_sum,
avg(sales) over(order by sales rows between 3 preceding and current row ) as total_average
from train;

select Category, `Sub-Category`,`Ship Mode`,Segment , Region,sales,
sum(sales) over(partition by Category order by sales rows between 3 preceding and current row ) as total_sum,
avg(sales) over( partition by Category order by sales rows between 3 preceding and current row ) as total_average
from train;
